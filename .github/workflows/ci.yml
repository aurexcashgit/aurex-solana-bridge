name: Aurex Solana Bridge CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  SOLANA_VERSION: 1.16.0
  NODE_VERSION: 18
  RUST_VERSION: 1.70.0

jobs:
  test-program:
    name: Test Solana Program
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Solana
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/solana/
            ~/.local/share/solana/
          key: solana-${{ env.SOLANA_VERSION }}
      
      - name: Install Solana
        run: |
          curl -sSfL https://release.solana.com/v${{ env.SOLANA_VERSION }}/install | sh
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: ${{ env.RUST_VERSION }}
          override: true
      
      - name: Cache Rust
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            program/target
          key: rust-${{ hashFiles('program/Cargo.lock') }}
      
      - name: Install Anchor
        run: |
          npm install -g @coral-xyz/anchor-cli
      
      - name: Run Solana Test Validator
        run: |
          solana-test-validator --background
          solana config set --url localhost
      
      - name: Build Program
        working-directory: ./program
        run: |
          anchor build
      
      - name: Test Program
        working-directory: ./program
        run: |
          anchor test --skip-local-validator

  test-sdk:
    name: Test TypeScript SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: sdk/package-lock.json
      
      - name: Install SDK dependencies
        working-directory: ./sdk
        run: npm ci
      
      - name: Build SDK
        working-directory: ./sdk
        run: npm run build
      
      - name: Test SDK
        working-directory: ./sdk
        run: npm test
      
      - name: Type check SDK
        working-directory: ./sdk
        run: npm run type-check

  test-api:
    name: Test Bridge API
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json
      
      - name: Install API dependencies
        working-directory: ./api
        run: npm ci
      
      - name: Build API
        working-directory: ./api
        run: npm run build
      
      - name: Test API
        working-directory: ./api
        run: npm test
        env:
          NODE_ENV: test
          SOLANA_RPC_URL: http://localhost:8899
          AUREX_API_KEY: test-key

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Run SDK security audit
        working-directory: ./sdk
        run: |
          npm audit --audit-level moderate
          npm run lint
      
      - name: Run API security audit
        working-directory: ./api
        run: |
          npm audit --audit-level moderate
          npm run lint
      
      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  deploy-devnet:
    name: Deploy to Devnet
    runs-on: ubuntu-latest
    needs: [test-program, test-sdk, test-api]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Solana
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/solana/
            ~/.local/share/solana/
          key: solana-${{ env.SOLANA_VERSION }}
      
      - name: Install Solana
        run: |
          curl -sSfL https://release.solana.com/v${{ env.SOLANA_VERSION }}/install | sh
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      
      - name: Setup deployment keypair
        run: |
          echo "${{ secrets.SOLANA_DEPLOY_KEY }}" > ~/.config/solana/id.json
          chmod 600 ~/.config/solana/id.json
          solana config set --url devnet
      
      - name: Install Anchor
        run: npm install -g @coral-xyz/anchor-cli
      
      - name: Deploy to Devnet
        working-directory: ./program
        run: |
          anchor build
          anchor deploy --provider.cluster devnet
      
      - name: Update program ID
        run: |
          PROGRAM_ID=$(solana-keygen pubkey program/target/deploy/aurex_solana_bridge-keypair.json)
          echo "Deployed program ID: $PROGRAM_ID"
          # Here you could update configs, notify services, etc.

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-devnet]
    if: success()
    steps:
      - name: Notify success
        run: |
          echo "âœ… Aurex Solana Bridge deployed successfully!"
          # Here you could send notifications to Slack, Discord, etc.